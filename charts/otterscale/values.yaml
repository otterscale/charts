# Global naming overrides
nameOverride: ""
fullnameOverride: ""

# -----------------------------------------------------------------------------
# OtterScale Service Configuration
# -----------------------------------------------------------------------------
otterscale:
  image:
    repository: ghcr.io/otterscale/otterscale/service
    tag: ""
    pullPolicy: IfNotPresent
  env: []

otterscaleWeb:
  image:
    repository: ghcr.io/otterscale/otterscale/web
    tag: ""
    pullPolicy: IfNotPresent
  env: []

# -----------------------------------------------------------------------------
# Service Mesh Configuration
# -----------------------------------------------------------------------------
istio:
  enabled: true
  externalIP: ""
  sidecarInjection:
    enabled: true
  virtualService:
    enabled: true

  # TLS configuration for Istio Gateway
  tls:
    # Enable TLS for the gateway
    enabled: false
    # Use an existing Secret (must contain tls.crt and tls.key)
    # If set, crt/key fields below are ignored
    existingSecret: ""
    # Alternatively, provide crt/key directly (base64-encoded)
    crt: ""
    key: ""

  # Gateway configuration for external traffic
  gateway:
    enabled: true
    hosts:
      - "*"

# -----------------------------------------------------------------------------
# Valkey Configuration (for otterscale-web)
# -----------------------------------------------------------------------------
valkey:
  enabled: true
  aclUsers:
    default:
      permissions: "~* &* +@all"
  password: ""

# -----------------------------------------------------------------------------
# Keycloak Configuration
# -----------------------------------------------------------------------------
keycloakx:
  enabled: true
  auth:
    adminPassword: ""
  client:
    id: otterscale
    secret: ""
  http:
    relativePath: /auth/

  command:
  - /bin/sh
  - -c
  - |
    /opt/keycloak/bin/kc.sh start \
    --verbose \
    --import-realm \
    --http-port=8080 \
    --http-enabled=true \
    --hostname-strict=false \
    --spi-events-listener-jboss-logging-success-level=info \
    --spi-events-listener-jboss-logging-error-level=warn

  extraEnvFrom: |
    - configMapRef:
        name: otterscale-keycloak-env
    - secretRef:
        name: otterscale-keycloak-admin

  dbchecker:
    enabled: true
  database:
    vendor: postgres
    database: keycloak
    username: keycloak
    existingSecret: keycloak-postgres
    existingSecretKey: "postgres-password"
    hostname: keycloak-postgres
    port: 5432
    image:
      repository: postgres
      tag: "15"
      pullPolicy: IfNotPresent
    persistence:
      enabled: true
      storageClassName: "microk8s-hostpath"
      accessMode: ReadWriteOnce
      size: 5Gi

  extraInitContainers: |
    - name: theme-provider
      image: ghcr.io/otterscale/keycloakify:1.0.6
      imagePullPolicy: IfNotPresent
      command:
        - sh
      args:
        - -c
        - |
          echo "Copying OtterScale theme..."
          cp -R /otterscale-theme.jar /otterscale-theme
          echo "$(ls -alh /otterscale-theme)"
      volumeMounts:
        - name: theme-import-volume
          mountPath: /otterscale-theme

  extraVolumeMounts: |
    - name: realm-import-volume
      mountPath: "/opt/keycloak/data/import/otterscale-realm.json"
      subPath: "otterscale-realm.json"
      readOnly: true
    - name: theme-import-volume
      mountPath: "/opt/keycloak/providers/otterscale-theme.jar"
      subPath: "otterscale-theme.jar"
      readOnly: true

  extraVolumes: |
    - name: realm-import-volume
      secret:
        secretName: otterscale-realm
    - name: theme-import-volume
      emptyDir: {}

# -----------------------------------------------------------------------------
# MAAS / Juju Configuration (Hand-made)
# -----------------------------------------------------------------------------
configContent: |
  maas:
    url: http://127.0.0.1:5240/MAAS
    key: xxx
    version: "2.0"
  juju:
    controller: maas-cloud-controller
    controller_addresses:
    - 127.0.0.1:17070
    username: admin
    password: xxx
    ca_cert: |
      -----BEGIN CERTIFICATE-----
      xxx
      -----END CERTIFICATE-----
    cloud_name: maas-cloud
    cloud_region: default
  ceph:
    rados_timeout: 0s
  keycloak:
    realm_url: http://127.0.0.1/auth/realms/otterscale
    client_id: otterscale

# -----------------------------------------------------------------------------
# Harbor Configuration (Container Registry)
# -----------------------------------------------------------------------------
# Harbor is accessed at <externalIP>/harbor/ via Istio pass-through routing.
# Harbor's native paths (/harbor/, /api/v2.0/, /c/, /v2/, etc.) are passed
# directly to the Harbor service without URI rewrite.
#
# Docker push/pull also works via the same IP:
#   docker login <externalIP>
#
# harbor.externalURL defaults to the same base URL as OtterScale (scheme://externalIP).
# Override only if Harbor needs a different base URL.
# -----------------------------------------------------------------------------
harbor:
  enabled: true
  # Base URL for Harbor (defaults to otterscale externalURL, e.g. http://<externalIP>)
  # Harbor internally appends /harbor/ for the UI.
  # IMPORTANT: Must match the actual browser URL scheme (http/https).
  # If set to https:// but accessed via http://, CSRF cookies will be rejected.
  externalURL: "http://127.0.0.1/harbor/"

  # Harbor admin password (change after first login)
  harborAdminPassword: "Harbor12345"

  # Expose via ClusterIP â€” Istio handles external ingress
  expose:
    type: clusterIP
    tls:
      enabled: false
    clusterIP:
      name: harbor
      ports:
        httpPort: 80

  ipFamily:
    ipv6:
      enabled: false

  # Persistence
  persistence:
    enabled: true
    persistentVolumeClaim:
      registry:
        storageClass: "microk8s-hostpath"
        size: 50Gi
      database:
        storageClass: "microk8s-hostpath"
        size: 5Gi
      jobservice:
        jobLog:
          storageClass: "microk8s-hostpath"
          size: 1Gi
      redis:
        storageClass: "microk8s-hostpath"
        size: 1Gi
      trivy:
        storageClass: "microk8s-hostpath"
        size: 5Gi

  # Internal PostgreSQL & Redis
  database:
    type: internal
  redis:
    type: internal

  # ---------------------------------------------------------
  # OIDC integration with Keycloak (custom values for parent chart)
  # These are NOT native Harbor chart values; they are used by
  # the harbor-oidc-job template to auto-configure OIDC via API.
  # ---------------------------------------------------------
  oidc:
    enabled: true
    # Harbor shares the 'otterscale' Keycloak client (no separate client needed)
    scope: "openid,profile,email"
    autoOnboard: true
    groupsClaim: "groups"
    adminGroup: "harbor_admins"